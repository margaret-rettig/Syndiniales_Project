---
title: "syndiniales_project"
author: "Margaret Rettig"
date: '2022-06-20'
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##R Setup

```{r}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("phyloseq")
```

```{r}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("DESeq2")
```

```{r}
install.packages("remotes")
remotes::install_github("Russel88/MicEco")
```

```{r}
library("devtools")
library("ggplot2")
library("phyloseq")
library("vegan")
library("DESeq2") # might not need
library("dendextend") #might not need
library("pBrackets") #might not need
library("tidyr")
library("viridis") #colors
library("reshape")
library("ape") # can't remember what this was for...
library("ggrepel")
library("tibble")
library("ggsci")
library("dplyr")
library("devtools")
library("readxl")
library("gplots")
library("ggpubr")
library("abdiv")
library("MicEco")
```

##Set Working Directory

```{r}
setwd("~/Desktop/surfo_project") #set files to save to folder on desktop
```

##Import Data

```{r}
counts <- read.table("~/Desktop/surfo_project/syn_asv_counts.tsv", header=T, row.names=1,check.names=F, sep="\t") #read in file with ASV counts as a table
taxa <- as.matrix(read.table("~/Desktop/surfo_project/syn_asv_taxonomy_correct.tsv",header=T, row.names=1,check.names=F, sep="\t")) #read file with taxa information as a matrix
samples <- read.table("~/Desktop/surfo_project/syn_sample_info (1).tsv", header=T, row.names=1,check.names=F, sep="\t") #read file with sample information as a table
```

##Create Data frames for basic dplyr analysis

```{r}
taxa_df <- as.data.frame(taxa)
taxa_df <- rownames_to_column(taxa_df, "ASV") #take row name labels and make them the first column variable
otus_df <- as.data.frame(counts)
```

##Create Phyloseq Object

```{r}
count_tab <- otu_table(counts, taxa_are_rows = TRUE, errorIfNULL = FALSE)
tax_tab <- tax_table(taxa) 
sample_info <- sample_data(samples)
ASV_phyloseq <- phyloseq(count_tab, tax_tab, sample_info) #creates phyloseq class object (used for genomic data analysis w/ phyloseq pacakge)
```

##Examine Taxa by Order

```{r}
ASV_number <- taxa_df %>%
  filter(!is.na(Order)) %>% 
  group_by(Order) %>%
  summarize(ASV_per_order = n()) %>% #compute number of ASVs in each order group
  arrange(-ASV_per_order) #arrange in descending order
head(ASV_number)
```

##Graph of ASVs per Order

```{r}
ggplot(data = ASV_number, mapping = aes(x = Order, y = ASV_per_order)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label = ASV_per_order), vjust = -0.2)
#bar graph of the number of ASVs per order
```

##Examine Taxa by Family

```{r}
taxa_df %>% 
  filter(!is.na(Family)) %>% 
  group_by(Family) %>% 
  summarize(ASVs_per_family = n()) %>% #calculate number of ASVs present in each family
  arrange(-ASVs_per_family) #arrange number in decreasing order
```

##Examine by Genus

```{r}
taxa_df %>%
  filter(!is.na(Genus)) %>% 
  group_by(Genus) %>%
  summarize(ASVs_per_genus = n()) %>% #calculate number of ASVs per genus
  arrange(-ASVs_per_genus)
```

##Examine counts by Species

```{r}
taxa_df %>%
  filter(!is.na(Species)) %>% 
  group_by(Species) %>%
  summarize(count = n()) %>% #number of ASVs per species
  arrange(-count)
```

##Community Composition

```{r}
#plot_bar(ASV_phyloseq, fill = "Order") #basic plot of abundance colored by order
plot_bar(ASV_phyloseq, x="Sample", fill ="Order") + 
    geom_bar(stat = "identity") +
    guides(fill = guide_legend(keywidth = 0.25, keyheight = 0.25))
  
```

```{r}
#plot_bar(ASV_phyloseq, fill = "depth_layer", facet_grid = "Order")
plot_bar(ASV_phyloseq, x="Sample", fill ="depth_layer", facet_grid = "Order")
    +geom_bar(stat="identity")
```

```{r}
plot_bar(ASV_phyloseq, x = "Order", fill = "depth_layer") +
  geom_bar(stat = "identity")
```

```{r}
plot_bar(ps_abundance, x = "depth_layer", y = "Abundance", fill = "Family") +
  geom_bar(stat = "identity") + 
  guides(fill = guide_legend(keywidth = 0.25, keyheight = 0.25))
```

```{r}
plot_bar(ps_abundance, x = "Order", fill = "depth_layer") +
  geom_bar(stat = "identity") 
  
```

```{r}
#ps_abundance <- transform_sample_counts(ASV_phyloseq, function(x) x/sum(x))

#dino_group_III <- subset_taxa(ps_abundance, Order == "Dino-Group-III")
#plot_bar(dino_group_III, "Family", fill = "Species", facet_grid = ~date) 

syndiniales <- subset_taxa(ps_abundance, Class == "Syndiniales")
plot_bar(syndiniales, "Class", fill = "Order", facet_grid = ~julianD) +
  geom_bar(stat = "identity") +
  guides(fill = guide_legend(keywidth = 0.25, keyheight = 0.25))
```

#Relative Abundance Percentage Calculation

```{r}
rel_abundance <- sample_and_taxa %>% 
  group_by(otu) %>%
  mutate(relative_abundance_percentage = (relative_abundance*100)) %>% 
  select(Order, relative_abundance_percentage, julianD, date)

```

```{r}
ggplot(rel_abundance, aes(fill = Order, y = relative_abundance_percentage, x = date)) +
    geom_bar(position = "fill", stat = "identity") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 

```

```{r}
plot_richness(ASV_phyloseq, x="julianD", color="depth",  measures=c("Chao1", "Shannon")) + 
  geom_point(size=2) +
  scale_color_gradient(low = "#56B1F7", high = "#132B43") +
  scale_fill_gradient(low = "#56B1F7", high = "#132B43") +
  theme(legend.title = element_blank())
```

```{r}
dino_order <- ASV_phyloseq %>% 
  tax_glom(taxrank = "Order") %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) %>% 
  psmelt() %>% 
  arrange(Class)
ggplot(dino_order, aes(x = date, y = Abundance, fill = Order)) +
  geom_bar(position = "fill", stat = "identity") +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance")
```

```{r}
 dino_genus <- ASV_phyloseq %>% 
  tax_glom(taxrank = "Genus") %>% 
   transform_sample_counts(function(x) {x/sum(x)} ) %>% 
   psmelt() %>% 
   arrange(Order)

ggplot(dino_genus, aes(x = date, y = Abundance, fill = Order)) +
  facet_grid('depth_layer') +
  geom_bar(position = "fill", stat = "identity") +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  guides(fill = guide_legend(keywidth = 0.25, keyheight = 0.25)) + 
  ylab("Relative Abundance") 
```

##Basic Plots

```{r}
plot_bar(ASV_phyloseq, "Order", fill = "Family", facet_grid = ~depth_layer) #potentially useful with some work

```

```{r}
alpha_meas = c("Observed", "Chao1", "ACE", "Shannon", "Simpson", "InvSimpson")
(p <- plot_richness(ASV_phyloseq, measures = alpha_meas)) #diversity measures are not particularly useful per tatiana 
```

##Depth / ASV Manipulation + Analysis

```{r}
rotated <- t(otus_df) #transpose data frame to have sample id as column name
rotated <- as.data.frame(rotated)
rotated <- rownames_to_column(rotated, "sample_id") #make column of sample IDs 
head(rotated) #check to make sure it worked
```

```{r}
join_rotated <- rownames_to_column(samples, "sample_id") #create column of sample IDs for joining
head(join_rotated) #check on it
```

**Join Rotated and join_rotated data frames to get sample data and ASV
counts in the same data frame**

```{r}
counts_samples <- left_join(rotated, join_rotated)
head(counts_samples)
```

**Calculate Number of ASVs per depth layer**

```{r}
counts_samples %>%
  group_by(depth_layer) %>%
  summarize(samples_per_layer = n()) %>% 
  arrange(-samples_per_layer)
```

```{r}
surf_ml_counts <- counts_samples %>% 
  filter(depth_layer == 'Surf-ML') #creates a table of 
head(surf_ml_counts)

```

```{r}
ml_100m_counts <- counts_samples %>%
  filter(depth_layer == 'ML-100m')
head(ml_100m_counts)
```

```{r}
surface_asv_counts <- rowSums(surf_ml_counts !=0)
print(surface_asv_counts)
surface_mean = mean(surface_asv_counts)
depth_asv_presence <- rowSums(ml_100m_counts !=0)
print(depth_asv_presence)
depth_mean = mean(depth_asv_presence)

stat.test <- t.test(surface_asv_counts, depth_asv_presence, paired = FALSE)
```

    Welch Two Sample t-test

data: surface_asv_counts and depth_asv_presence t = -5.5731, df =
30.585, p-value = 4.338e-06 alternative hypothesis: true difference in
means is not equal to 0 95 percent confidence interval: -47.02507
-21.81779 sample estimates: mean of x mean of y 127.8286 162.2500 **Add
Standard Deviation**

```{r}
surface_sd <- sd(surface_asv_counts)
surface_sd
depth_sd <- sd(depth_asv_presence)
depth_sd
```

##Time / ASV Manipulation + Analysis

```{r}
epoch_ASV <- counts_samples %>%
  group_by(epoch) # %>%
  #summarize(samples_per_epoch = n()) %>% 
 # arrange(-samples_per_epoch)
print(epoch_ASV)
```

**Epoch 1 Data Filtering and Calculations**

```{r}
epoch1_samples <- counts_samples %>% 
  filter(epoch == "E1")  %>% 
  mutate(epoch1_counts) %>% 
  select(sample_id, epoch, epoch1_counts)
epoch1_counts <- rowSums(epoch1_samples != 0)
print(epoch1_counts)
epoch1_mean = mean(epoch1_counts)
print(epoch1_mean)
```

Epoch Means: 154 115 139 127 122 117 143 138 163 125 Average Epoch 1
Mean: 134.3

```{r}
sd(epoch1_counts)
```

Epoch 1 Standard Deviation: 15.93773

**Epoch 2 Data Filtering and Calculations**

```{r}
epoch2_samples <- counts_samples %>% 
  filter(epoch == "E2") #%>% 
  # mutate(epoch2_counts) %>% 
  # select(sample_id, epoch, epoch2_counts)
epoch2_counts <- rowSums(epoch2_samples != 0)
print(epoch2_counts)
epoch2_mean = mean(epoch2_counts)
print(epoch2_mean)
```

Epoch 2 Mean ASV Counts: 172 142 120 120 81 112 127 193 210 85 121 109
161 Epoch 2 Average ASV Count: 134.8462

```{r}
sd(epoch2_counts)
```

Epoch 2 ASV presence standard deviation: 39.17237

**Epoch 3 Data Filtering and Calculations**

```{r}
epoch3_samples <- counts_samples %>% 
   filter(epoch == "E3") #%>%
  # mutate(epoch3_counts) %>% 
  # select(sample_id, epoch, epoch3_counts)
epoch3_counts <- rowSums(epoch3_samples != 0)
print(epoch3_counts)
epoch3_mean = mean(epoch3_counts)
print(epoch3_mean)
```

Epoch 3 Sample ASV Presence: 159 141 123 127 123 177 149 164 115 132 185
162 132 130 207 134 150 161 175 177 132 134 145 141 122 130 130 136 129
124 147 130 Epoch 3 Average ASV Count: 144.4688

```{r}
sd(epoch3_counts)
```

Epoch 3 ASV presence standard deviation: 21.78337

**Merge ASV Presence Tables**

```{r}
epoch1_samples_df <- as.data.frame(epoch1_samples)
epoch2_samples_df <- as.data.frame(epoch2_samples)
epoch3_samples_df <- as.data.frame(epoch3_samples)
epoch1_samples_temp <- rename(epoch1_samples_df, epoch_counts = epoch1_counts)
epoch2_temp <- rename(epoch2_samples_df, epoch_counts = epoch2_counts)
epoch3_temp <- rename(epoch3_samples_df, epoch_counts = epoch3_counts) 
presence_epoch_1 <- rbind(epoch1_samples_temp, epoch2_temp, by = 'sample_id')
presence_epoch_2 <- rbind(presence_epoch_1, epoch3_temp, by = "sample_id")
presence_epoch_3 <- presence_epoch_2[-c(24),]
presence_epoch_final <- presence_epoch_3[-c(56),]
```

**ANOVA to test for statistical significance in variance of means**

```{r}
epoch_aov <-aov(epoch_counts ~ epoch, data = presence_epoch_final)
summary(epoch_aov)
```

            Df Sum Sq Mean Sq F value Pr(>F)

epoch 2 1580 790 1.16 0.321 Residuals 52 35410 681

P value is greater then the significance level of 0.05, so we support
the null hypothesis. The difference between the means is not
statistically significant.

##Boxplots

```{r}
E1_summary <- summary(epoch1_counts)
print(E1_summary)
E2_summary <- summary(epoch2_counts)
print(E2_summary)
E3_summary <- summary(epoch3_counts)
E3_summary
```

```{r}
# ggplot(presence_epoch_final, aes(epoch, epoch_counts)) +
#   geom_boxplot(outlier.colour="black", outlier.shape=16,
#              outlier.size=2, notch=FALSE)

boxplot(E1_summary, E2_summary, E3_summary, main = "ASV Presence Over Time", ylab = "Epoch", xlab = 'Number of ASVs Present', names = c("E1", "E2", "E3"), col = "dark green", horizontal = TRUE)
```

```{r}
surf_sum <- summary(surface_asv_counts)
surf_sum
depth_sum <- summary(depth_asv_presence)
depth_sum
summaries <- rbind(surf_sum, depth_sum)
summaries_df <- as.data.frame(summaries)
```

```{r}
a <- boxplot(surf_sum, depth_sum, main = "ASV Presence Variation Across Depths", names = c("Surface - ML", "ML - 100M"), horizontal = FALSE, xlab = "Number of ASVs Present", ylab = "Depth") 
```

##NMDS Plot

```{r}
syn_nmds <- ordinate(ASV_phyloseq, method="NMDS", distance="jaccard")
syn_nmds$stress #0.06 good fit
plot_ordination(ASV_phyloseq, syn_nmds, color="layer_epoch") +
  scale_color_manual(values=c("#FFDB6D", "#56B4E9", "#C4961A", "#4E84C4", "#D16103", "#293352")) +
  scale_fill_manual(values=c("#FFDB6D", "#56B4E9", "#C4961A", "#4E84C4", "#D16103", "#293352")) +
  geom_point(aes(colour=factor(layer_epoch))) +
  geom_point(size=3)+
  labs(col="layer_epoch") + 
  theme_bw()+
  theme(legend.title = element_blank())
```

##Ordination Plot

```{r}
pcoa <- ordinate(ASV_phyloseq, method="MDS", distance="euclidean")
eigen_vals <- pcoa$values$Eigenvalues 

plot_ordination(ASV_phyloseq, pcoa, color="layer_epoch") +
  scale_color_manual(values=c("#FFDB6D", "#56B4E9", "#C4961A", "#4E84C4", "#D16103", "#293352")) +
  scale_fill_manual(values=c("#FFDB6D", "#56B4E9", "#C4961A", "#4E84C4", "#D16103", "#293352")) +
  geom_point(aes(colour=factor(layer_epoch))) +
  #geom_point(aes(shape=factor(type)),size=3) + 
  labs(col="layer_epoch") + 
  stat_ellipse(geom = "polygon", alpha = 0.2, aes(group = depth_layer))+
  coord_fixed(sqrt(eigen_vals[2]/eigen_vals[1])) + 
  theme_bw()+
  theme(legend.title = element_blank())
```

##Relative Abundance / Presence Absence

```{r}
OTU.clean.relabund <- sweep(otus_df,1,rowSums(otus_df),"/")
rowSums(OTU.clean.relabund)
```

```{r}
ggplot(OTU.clean.relabund, aes(x = date, y = Abundance, fill = Order)) +
  geom_bar(position = "fill", stat = "identity") +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  guides(fill = guide_legend(keywidth = 0.25, keyheight = 0.25)) + 
  ylab("Relative Abundance") 
```

##Venn Diagram **Jaccard Index Surface Samples vs. Depth Samples**

```{r}
jaccard <- jaccard(surf_ml_counts, depth_asv_presence)
jaccard
```

```{r}
counts[counts > 0] <- 1
as.matrix(counts)
```

```{r}
for(i in 1:nrow(counts)) {
  for(j in 1:ncol(counts)){
    if(counts[i,j] != 0) {
      cat(i, j, "\n")
    }
  }
}
```

```{r}
venn <- ps_venn(ASV_phyloseq, 'depth_layer', plot = FALSE)
venn
```

```{r}
ps_venn(ASV_phyloseq, 'depth_layer')
```

##Dendrogram

```{r}
set.seed(1)
dist_bray <- phyloseq::distance(ASV_phyloseq, method = "bray")
comm.bray.clust <- hclust(dist_bray, method = "average")
plot(comm.bray.clust, ylab = "Bray-Curtis dissimilarity")
```

##Dissimlarity Comparison

```{r}

```

##Taxonomy Information **Depth Community**

```{r}
ML_taxa <- subset(taxa_df, ASV %in% venn$`ML-100m`)
ML_taxa
```

```{r}
ML_order <- ML_taxa %>%
  filter(!is.na(Order)) %>% 
  group_by(Order) %>%
  dplyr::summarize(ASV_per_order = n()) %>% #compute number of ASVs in each order group
  arrange(-ASV_per_order) #arrange in descending order
head(ML_order)
```

```{r}
ggplot(data = ML_order, mapping = aes(x = Order, y = ASV_per_order)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = ASV_per_order), vjust = -0.2)
```

**Surface Community**

```{r}
surface_taxa <- subset(taxa_df, ASV %in% venn$`Surf-ML`)
surface_taxa
```

```{r}
surface_order <- surface_taxa %>%
  filter(!is.na(Order)) %>% 
  group_by(Order) %>%
  dplyr::summarize(ASV_per_order = n()) %>% #compute number of ASVs in each order group
  arrange(-ASV_per_order) #arrange in descending order
head(surface_order)
```

```{r}
ggplot(data = surface_order, mapping = aes(x= Order, y = ASV_per_order)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = ASV_per_order), vjust = -0.2)
```
**Shared ASVs**
```{r}
shared_taxa <- subset(taxa_df, ASV %in% venn$`ML-100m__Surf-ML`)
shared_taxa
```
```{r}
shared_order <- shared_taxa %>%
  filter(!is.na(Order)) %>% 
  group_by(Order) %>%
  dplyr::summarize(ASV_per_order = n()) %>% #compute number of ASVs in each order group
  arrange(-ASV_per_order) #arrange in descending order
head(shared_order)
```
```{r}
ggplot(data = shared_order, mapping = aes(x = Order, y = ASV_per_order)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = ASV_per_order))
```
 
